// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ユーザーテーブル（UUIDを主キーとして管理）
// ========================================
model User {
  uuid        String  @id @default(uuid()) // Minecraft UUID（主キー）
  mcid        String  @unique // Minecraft ID（変更可能）
  passphrase  String? // パスフレーズ（変更時の認証用、ハッシュ化）
  displayName String? // 表示名
  isGuest     Boolean @default(false) // ゲストユーザーフラグ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  config        PlayerConfig?  @relation("config") // 新スキーマ
  keybindings   Keybinding[]
  customKeys    CustomKey[] // カスタムキー定義
  keyRemaps     KeyRemap[]
  externalTools ExternalTool[]
  itemLayouts   ItemLayout[]
  searchCrafts  SearchCraft[] // サーチクラフト設定

  // 旧スキーマ（移行用・削除予定）
  playerSettings PlayerSettings? @relation("playerSettings")
}

// ========================================
// プレイヤー設定テーブル（デバイス・環境設定のみ）
// ========================================
model PlayerConfig {
  uuid String @id // Minecraft UUID（主キー）
  user User   @relation("config", fields: [uuid], references: [uuid], onDelete: Cascade)

  // キーボード設定
  keyboardLayout String @default("JIS") // "JIS" or "US"

  // マウス設定
  mouseDpi          Int? // マウスDPI
  gameSensitivity   Float? // ゲーム内感度 (Options.txt形式: 0.0-1.0)
  windowsSpeed      Int? // Windowsマウス速度 (1-20)
  mouseAcceleration Boolean @default(false) // マウス加速の有無
  rawInput          Boolean @default(true) // RawInput使用の有無
  cm360             Float? // 振り向き（cm/180度）- 自動計算

  // ゲーム設定
  toggleSprint Boolean? @default(false) // スプリント切り替え
  toggleSneak  Boolean? @default(false) // スニーク切り替え
  autoJump     Boolean? @default(false) // オートジャンプ

  // 指割り当て設定
  fingerAssignments Json? // キーコード → 指の配列のマッピング

  // プレイヤー環境設定
  gameLanguage  String? // ゲーム内の言語
  mouseModel    String? // 使用マウスの機種
  keyboardModel String? // 使用キーボードの機種
  notes         String? @db.Text // 自由使用欄

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([uuid])
}

// ========================================
// キーバインドテーブル（正規化）
// ========================================
model Keybinding {
  id       String @id @default(cuid())
  uuid     String // User UUID
  action   String // アクション名（例: "forward", "attack", "hotbar1", "custom_reset"）
  keyCode  String // Web標準 or カスタムキーコード（例: "KeyW", "Mouse0", "CustomKey1"）
  category String // カテゴリ（"movement", "combat", "inventory", "ui", "custom"）

  // 指割り当て（このキーを押す指）
  // 例: ["left-middle"], ["left-ring", "left-pinky"]
  fingers String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [uuid], references: [uuid], onDelete: Cascade)

  @@unique([uuid, action]) // 1ユーザー1アクション1キー（複数キー割り当て禁止）
  @@index([uuid])
  @@index([action])
  @@index([keyCode])
}

// ========================================
// カスタムキーテーブル（ユーザー定義のキー）
// ========================================
model CustomKey {
  id       String  @id @default(cuid())
  uuid     String // User UUID
  keyCode  String // カスタムキーコード（例: "CustomKey1", "Mouse10"）
  keyName  String // 表示名（例: "G1ボタン", "サイドボタン上"）
  category String // カテゴリ（"mouse", "keyboard"）
  position Json? // キー位置情報（オプション）
  size     Json? // キーサイズ情報（オプション）
  notes    String? // メモ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [uuid], references: [uuid], onDelete: Cascade)

  @@unique([uuid, keyCode]) // 1ユーザー1キーコード1レコード
  @@index([uuid])
  @@index([keyCode])
}

// ========================================
// キーリマップテーブル（物理キーの入れ替え）
// ========================================
model KeyRemap {
  id        String  @id @default(cuid())
  uuid      String // User UUID
  sourceKey String // 元のキー（例: "CapsLock"）
  targetKey String? // リマップ先（例: "ControlLeft"）/ null = 無効化

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [uuid], references: [uuid], onDelete: Cascade)

  @@unique([uuid, sourceKey]) // 1ユーザー1元キー1レコード
  @@index([uuid])
}

// ========================================
// 外部ツールアクションテーブル（AHK、マクロなど）
// ========================================
model ExternalTool {
  id          String  @id @default(cuid())
  uuid        String // User UUID
  triggerKey  String // トリガーキー（例: "KeyF", "KeyX"）
  toolName    String // ツール名（例: "Ninb", "SeedQueue", "AutoHotKey"）
  actionName  String // アクション名（例: "リセット", "Reset All"）
  description String? @db.Text // 説明

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [uuid], references: [uuid], onDelete: Cascade)

  @@index([uuid])
  @@index([triggerKey])
}

// ========================================
// アイテム配置テーブル（Speedrunセグメントごとのホットバー配置）
// ========================================
model ItemLayout {
  uuid    String // Minecraft UUID
  segment String // セグメント名（例: "Overworld", "Nether", "End"）

  // ホットバー（各スロットに複数アイテムを配置可能）
  slot1   String[]
  slot2   String[]
  slot3   String[]
  slot4   String[]
  slot5   String[]
  slot6   String[]
  slot7   String[]
  slot8   String[]
  slot9   String[]
  offhand String[]

  notes String? @db.Text // メモ欄

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [uuid], references: [uuid], onDelete: Cascade)

  @@id([uuid, segment])
  @@index([uuid])
}

// ========================================
// サーチクラフトテーブル（クラフトアイテムとキー入力の登録）
// ========================================
model SearchCraft {
  id       String @id @default(cuid())
  uuid     String // User UUID
  sequence Int // 連番（1から始まる）

  // クラフト対象アイテム（最大3個）
  item1 String?
  item2 String?
  item3 String?

  // 押すキー（Web形式、最大4キー）
  key1 String?
  key2 String?
  key3 String?
  key4 String?

  // コメント（任意）
  comment String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [uuid], references: [uuid], onDelete: Cascade)

  @@unique([uuid, sequence])
  @@index([uuid])
}

// ========================================
// 旧スキーマ - 移行用（削除予定）
// ========================================
model PlayerSettings {
  uuid String @id // Minecraft UUID（主キー）
  user User   @relation("playerSettings", fields: [uuid], references: [uuid], onDelete: Cascade)

  // キーボード設定
  keyboardLayout String @default("JIS")

  // マウス設定
  mouseDpi          Int?
  gameSensitivity   Float?
  windowsSpeed      Int?
  mouseAcceleration Boolean @default(false)
  rawInput          Boolean @default(true)
  cm360             Float?

  // キーバインド（27個の標準キー）
  forward           String @default("key.keyboard.w")
  back              String @default("key.keyboard.s")
  left              String @default("key.keyboard.a")
  right             String @default("key.keyboard.d")
  jump              String @default("key.keyboard.space")
  sneak             String @default("key.keyboard.left.shift")
  sprint            String @default("key.keyboard.left.control")
  attack            String @default("key.mouse.left")
  use               String @default("key.mouse.right")
  pickBlock         String @default("key.mouse.middle")
  drop              String @default("key.keyboard.q")
  inventory         String @default("key.keyboard.e")
  swapHands         String @default("key.keyboard.f")
  hotbar1           String @default("key.keyboard.1")
  hotbar2           String @default("key.keyboard.2")
  hotbar3           String @default("key.keyboard.3")
  hotbar4           String @default("key.keyboard.4")
  hotbar5           String @default("key.keyboard.5")
  hotbar6           String @default("key.keyboard.6")
  hotbar7           String @default("key.keyboard.7")
  hotbar8           String @default("key.keyboard.8")
  hotbar9           String @default("key.keyboard.9")
  togglePerspective String @default("key.keyboard.f5")
  fullscreen        String @default("key.keyboard.f11")
  chat              String @default("key.keyboard.t")
  command           String @default("key.keyboard.slash")
  toggleHud         String @default("key.keyboard.f1")

  // JSON設定フィールド
  fingerAssignments  Json? // キーコード → 指の配列
  remappings         Json? // キーリマップ設定
  externalTools      Json? // 外部ツール設定
  additionalSettings Json? // カスタムアクション

  // プレイヤー環境設定
  gameLanguage  String?
  mouseModel    String?
  keyboardModel String?
  notes         String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([uuid])
}
